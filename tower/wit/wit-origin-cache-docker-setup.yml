---
- hosts: all

  tasks:

  - name: Docker | Data container
    docker:
      name: "{{container}}-data"
      image: ubuntu:14.04
      state: reloaded
      volumes:
        - "{{ source_path }}/{{ container }}:/u/apps/site"

  - name: Docker | Beanstalkd
    docker:
      name: "{{container}}-beanstalkd"
      image: scientiamobile/base.beanstalkd
      state: reloaded
      email: "{{ docker_hub_email }}"
      username: "{{ docker_hub_username }}"
      password: "{{ docker_hub_password }}"

  - name: Docker | php fpm container
    docker:
      name: "{{container}}-php-fpm"
      image: scientiamobile/base.php-fpm
      state: reloaded
      email: "{{ docker_hub_email }}"
      username: "{{ docker_hub_username }}"
      password: "{{ docker_hub_password }}"
      volumes:
        - "{{ source_path }}/{{ container }}/docker/resources/supervisor-wit-worker.conf:/etc/supervisor/conf.d/wit-origin-cache-worker.conf"
      volumes_from:
        - "{{container}}-data"
      links:
        - "{{container}}-beanstalkd:beanstalkd"

  - name: Docker | Nginx
    docker:
      name: "{{container}}-nginx"
      image: scientiamobile/base.nginx
      state: reloaded
      email: "{{ docker_hub_email }}"
      username: "{{ docker_hub_username }}"
      password: "{{ docker_hub_password }}"
      volumes_from:
        - "{{container}}-data"
      links:
        - "{{container}}-php-fpm:fcgi"
      ports:
        - "80:80"
